@namespace Docs.Modules.Categories

@* @inject SubjectService SubjectService *@
@inject CategoriesVMService CategoriesService
@* @inject DocsService DocsService *@
@* @inject AppState AppState *@
@inject PersistentComponentState PersistantComponentState
@implements IDisposable

<MudGrid>
    <MudItem xs="12">

        <MudPaper Outlined="true" Class="pa-5">
            @* <h3>Tematy</h3> *@
            <MudStack Row="true">
                @foreach (var subject in categories)
                {
                    <MudButton OnClick="@(() => SelectSubject(subject))" Variant="Variant.Filled" Size="Size.Small"
                               Color="selectedCategory == subject ? Color.Primary : Color.Inherit">
                        @subject.Name
                    </MudButton>
                }
            </MudStack>
        </MudPaper>
    </MudItem>
</MudGrid>


@code {

    [CascadingParameter] public Task<AuthenticationState> AuthStateTask { get; set; }

    // [Parameter] public EventCallback<Subject> OnSubjectSelected { get; set; }
    [Parameter] public EventCallback<CategoryVM> OnSubjectSelected { get; set; }

    // Subject selectedSubject;
    CategoryVM selectedCategory;

    // HashSet<Subject> subjects = [];
    HashSet<CategoryVM> categories = [];
    PersistingComponentStateSubscription subscription;


    protected override async Task OnInitializedAsync()
    {
        var user = (await AuthStateTask).User.Identity is { IsAuthenticated: true } ? (await AuthStateTask).User.Identity.Name : string.Empty;

        subscription = PersistantComponentState.RegisterOnPersisting(() =>
        {
            PersistantComponentState.PersistAsJson("CategoriesInComp", categories);
            return Task.CompletedTask;
        });

        categories = PersistantComponentState.TryTakeFromJson<HashSet<CategoryVM>>("CategoriesInComp", out var restored)
            ? restored
            : (await CategoriesService.GetCategories(user)).Data;

        if (categories != null) selectedCategory = categories.FirstOrDefault();
        await OnSubjectSelected.InvokeAsync(selectedCategory);
        /*
        try
        var sw = Stopwatch.StartNew();
        {
            if (PersistantComponentState.TryTakeFromJson<HashSet<SubjectVM>>("SubjectsInComp", out var restored))
            {
                subjects = restored;
                Log.Error("RESTORED (SubjectComp)");
            }
            else
            {
                subjects = (await SubjectService.GetSubjects(user)).data;
                Log.Error("DB (SubjectComp)");
            }
        }
        finally
        {
            sw.Stop();
            Log.Warning($"POMIAR KOMPONENT TEMATÓW: {sw.ElapsedMilliseconds} ms");
        }
    */
    }

    // async Task SelectSubject(Subject? subject)
    async Task SelectSubject(CategoryVM? category)
    {
        if (category != null) selectedCategory = category;
        await OnSubjectSelected.InvokeAsync(selectedCategory);

        /*await  InvokeAsync(() =>
          {
              AppState.SetRecentSubjectId(subjectId);
              StateHasChanged();
          });*/
    }

    public void Dispose()
    {
        subscription.Dispose();
        AuthStateTask.Dispose();
    }

}