name: Build and deploy ASP.Net Core app to Azure Web App - docs-mac

on:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        
        env:
            PATH_TO_PROJECT: Docs/Docs.csproj
        
        steps:
            - uses: actions/checkout@v4
            
            # SET UP DOT NET CORE
            - name: Set up .NET Core
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: '8.0.x'
            
            # GET TARGET FRAMEWORK AND SET TO VARIABLE
            - name: Get target framework and set to variable
              id: get-framework
              run: |
                  has_version_9=false
                  target_framework=$(grep -oP '(?<=<TargetFramework>)[^<]+' ${{ env.PATH_TO_PROJECT }})
                  echo "TARGET FRAMEWORK: $target_framework"
                  echo "target_framework=$target_framework" >> $GITHUB_ENV
                  if [ "$target_framework" != "net8.0" ];then
                    has_version_9=true
                  fi
                  echo "has_version_9=$has_version_9" >> $GITHUB_ENV
            
            # LOG DEBUG INFORMATION
            - name: Log debug information
              run: |
                  echo "Environment variables:"
                  echo "PATH_TO_PROJECT: ${{ env.PATH_TO_PROJECT }}"
                  echo "TARGET_FRAMEWORK: ${{ env.target_framework }}"
                  echo "HAS_VERSION_9: ${{ env.has_version_9 }}"
                  ls -la
            
            # SET TARGET FRAMEWORK IN DOCS.CSPROJ
            - name: Set target framework in Docs.csproj
              if: env.has_version_9 == 'true'
              run: |
                  echo "Updating target framework to net8.0..."
                  sed -i 's|<TargetFramework>.*</TargetFramework>|<TargetFramework>net8.0</TargetFramework>|' ${{ env.PATH_TO_PROJECT }}
            
            # REMOVE DEPENDENCIES IF DOTNET 9
            - name: Remove dependencies if using .NET 9
              if: env.has_version_9 == 'true'
              run: |
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Components.Authorization
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Identity.EntityFrameworkCore
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Design
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Tools
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.SqlServer
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Relational
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Abstractions
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Analyzers
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.Extensions.Caching.Memory
                  dotnet remove ${{ env.PATH_TO_PROJECT }} package Microsoft.Extensions.Logging
            
            # ADD DEPENDENCIES FOR DOTNET 8
            - name: Add dependencies for .NET 8
              if: env.has_version_9 == 'true'
              run: |
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Components.Authorization
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.AspNetCore.Identity.EntityFrameworkCore
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Design
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Tools
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.SqlServer
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Relational
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Abstractions
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.EntityFrameworkCore.Analyzers
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.Extensions.Caching.Memory
                  dotnet add ${{ env.PATH_TO_PROJECT }} package Microsoft.Extensions.Logging
                  
            
            # RESTORE DEPENDENCIES AGAIN
            - name: Restore dependencies again
              run: dotnet restore ${{ env.PATH_TO_PROJECT }}
            
            # BUILD WITH DOTNET
            - name: Build with dotnet
              run: dotnet build ${{ env.PATH_TO_PROJECT }} --configuration Release
            
            # DOTNET PUBLISH
            - name: Dotnet publish
              run: dotnet publish ${{ env.PATH_TO_PROJECT }} -c Release -o ${{ env.DOTNET_ROOT }}/myapp
            
            # UPLOAD ARTIFACT FOR DEPLOYMENT JOB
            - name: Upload artifact for deployment job
              uses: actions/upload-artifact@v4
              with:
                  name: .net-app
                  path: ${{ env.DOTNET_ROOT }}/myapp
    
    deploy:
        runs-on: ubuntu-latest
        needs: build
        environment:
            name: 'Production'
            url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
        
        steps:
            - name: Download artifact from build job
              uses: actions/download-artifact@v4
              with:
                  name: .net-app

            - name: Deploy to Azure Web App
              id: deploy-to-webapp
              uses: azure/webapps-deploy@v3
              with:
                  app-name: 'docs-mac'
                  slot-name: 'Production'
                  package: .
                  publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_C725955FE1C6444D874C19A5265B420D }}